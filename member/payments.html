<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment History - Society Maintenance</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/member.css">
    <link rel="stylesheet" href="../css/print.css">
</head>
<body>
    <div class="member-layout">
        <!-- Header -->
        <header class="member-header">
            <div class="member-header-inner">
                <a href="dashboard.html" class="member-logo">
                    <div class="member-logo-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <span class="member-logo-text">Society Maintenance</span>
                </a>

                <nav class="member-nav">
                    <a href="dashboard.html" class="member-nav-link">Dashboard</a>
                    <a href="bills.html" class="member-nav-link">My Bills</a>
                    <a href="payments.html" class="member-nav-link active">Payments</a>
                </nav>

                <button class="mobile-nav-toggle" onclick="toggleMobileNav()">â˜°</button>

                <div class="member-user">
                    <div class="member-user-info">
                        <div class="member-user-name" id="user-name">Member</div>
                        <div class="member-user-flat" id="user-flat">Flat -</div>
                    </div>
                    <div class="member-user-avatar" id="user-avatar">M</div>
                    <button class="member-logout-btn" onclick="handleLogout()" title="Logout">ðŸšª</button>
                </div>
            </div>
        </header>

        <!-- Mobile Navigation -->
        <nav class="member-mobile-nav">
            <a href="dashboard.html" class="member-nav-link">Dashboard</a>
            <a href="bills.html" class="member-nav-link">My Bills</a>
            <a href="payments.html" class="member-nav-link active">Payments</a>
        </nav>

        <!-- Content -->
        <div class="member-content">
            <div class="page-header">
                <h2>Payment History</h2>
            </div>

            <!-- Summary -->
            <div class="member-stats mb-4">
                <div class="member-stat">
                    <div class="member-stat-icon payments">ðŸ’°</div>
                    <div>
                        <div class="member-stat-value" id="stat-total-paid">â‚¹ 0</div>
                        <div class="member-stat-label">Total Paid</div>
                    </div>
                </div>
                <div class="member-stat">
                    <div class="member-stat-icon bills">ðŸ“‹</div>
                    <div>
                        <div class="member-stat-value" id="stat-payment-count">0</div>
                        <div class="member-stat-label">Payments Made</div>
                    </div>
                </div>
            </div>

            <!-- Payment List -->
            <div class="bill-card">
                <ul class="payment-history-list" id="payments-list">
                    <li class="empty-state" style="padding: 2rem;">
                        <p class="text-muted text-center">Loading...</p>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal-backdrop" id="receipt-modal">
        <div class="modal">
            <div class="modal-header">
                <h5>Payment Receipt</h5>
                <button class="modal-close" onclick="closeModal('receipt-modal')">Ã—</button>
            </div>
            <div class="modal-body" id="receipt-content">
                <!-- Receipt content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('receipt-modal')">Close</button>
                <button class="btn btn-primary" onclick="printReceipt()">Print Receipt</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner spinner-lg"></div>
        <div class="loading-message">Loading...</div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await initMemberPortal();
            renderPayments();
        });

        function renderPayments() {
            const container = document.getElementById('payments-list');

            // Update stats
            const totalPaid = memberPayments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('stat-total-paid').textContent = Utils.formatCurrency(totalPaid);
            document.getElementById('stat-payment-count').textContent = memberPayments.length;

            if (memberPayments.length === 0) {
                container.innerHTML = `
                    <li class="empty-state" style="padding: 2rem;">
                        <p class="text-muted text-center">No payments found</p>
                    </li>
                `;
                return;
            }

            // Sort by date descending
            const sortedPayments = Utils.sortBy(memberPayments, 'paymentDate', 'desc');

            const modeLabels = {
                cash: 'Cash',
                cheque: 'Cheque',
                upi: 'UPI',
                bank_transfer: 'Bank Transfer'
            };

            container.innerHTML = sortedPayments.map(payment => {
                const bill = payment.billId ? memberBills.find(b => b.id === payment.billId) : null;

                return `
                    <li class="payment-history-item" onclick="viewReceipt('${payment.id}')" style="cursor: pointer;">
                        <div class="payment-info">
                            <div class="payment-icon">ðŸ’°</div>
                            <div class="payment-details">
                                <span class="payment-receipt">${payment.receiptNo}</span>
                                <span class="payment-mode">${modeLabels[payment.paymentMode] || payment.paymentMode}${bill ? ' - ' + bill.billNo : ''}</span>
                            </div>
                        </div>
                        <div class="payment-amount-date">
                            <span class="payment-amount">${Utils.formatCurrency(payment.amount)}</span>
                            <span class="payment-date">${Utils.formatDate(payment.paymentDate)}</span>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function viewReceipt(paymentId) {
            const payment = memberPayments.find(p => p.id === paymentId);
            if (!payment) return;

            const bill = payment.billId ? memberBills.find(b => b.id === payment.billId) : null;

            const modeLabels = {
                cash: 'Cash',
                cheque: 'Cheque',
                upi: 'UPI',
                bank_transfer: 'Bank Transfer'
            };

            const content = document.getElementById('receipt-content');
            content.innerHTML = `
                <div class="receipt-document" id="printable-receipt" style="padding: 1.5rem; border: 1px solid var(--gray-200); border-radius: var(--radius);">
                    <div class="receipt-header text-center mb-4" style="border-bottom: 2px solid var(--gray-200); padding-bottom: 1rem;">
                        <h4 style="color: var(--primary); margin-bottom: 0.25rem;">${Utils.escapeHtml(settings.societyName || 'Society Name')}</h4>
                        <p class="text-muted mb-2" style="font-size: 0.8125rem;">${Utils.escapeHtml(settings.address || '')}</p>
                        <h5>PAYMENT RECEIPT</h5>
                    </div>

                    <div class="receipt-body">
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                <strong>Receipt No:</strong> ${payment.receiptNo}
                            </div>
                            <div>
                                <strong>Date:</strong> ${Utils.formatDate(payment.paymentDate)}
                            </div>
                        </div>

                        <div class="mb-3 p-3" style="background: var(--gray-50); border-radius: var(--radius);">
                            <div class="mb-2"><strong>Received From:</strong></div>
                            <div>Flat: ${memberFlat ? Utils.escapeHtml(memberFlat.flatNo) : '-'}</div>
                            <div>Owner: ${memberFlat ? Utils.escapeHtml(memberFlat.ownerName) : '-'}</div>
                        </div>

                        <div class="text-center p-4 mb-3" style="background: var(--success); color: white; border-radius: var(--radius);">
                            <div style="font-size: 0.875rem;">Amount Received</div>
                            <div style="font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono);">${Utils.formatCurrency(payment.amount)}</div>
                        </div>

                        <table class="table" style="font-size: 0.875rem;">
                            <tr>
                                <td>Payment Mode</td>
                                <td class="text-right"><strong>${modeLabels[payment.paymentMode]}</strong></td>
                            </tr>
                            ${payment.referenceNo ? `
                                <tr>
                                    <td>Reference No.</td>
                                    <td class="text-right"><strong>${Utils.escapeHtml(payment.referenceNo)}</strong></td>
                                </tr>
                            ` : ''}
                            ${bill ? `
                                <tr>
                                    <td>Against Bill</td>
                                    <td class="text-right"><strong>${bill.billNo}</strong></td>
                                </tr>
                            ` : ''}
                        </table>
                    </div>

                    <div class="receipt-footer text-center mt-4 pt-3" style="border-top: 1px dashed var(--gray-300);">
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">Thank you for your payment!</p>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">This is a computer generated receipt.</p>
                    </div>
                </div>
            `;

            Utils.openModal('receipt-modal');
        }

        function printReceipt() {
            Utils.printElement('printable-receipt');
        }

        function closeModal(modalId) {
            Utils.closeModal(modalId);
        }
    </script>
</body>
</html>
