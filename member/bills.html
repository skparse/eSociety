<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>My Bills - eSociety</title>
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/svg+xml" href="../icons/icon.svg">
    <link rel="apple-touch-icon" href="../icons/icon-192.png">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/member.css">
    <link rel="stylesheet" href="../css/print.css">
    <link rel="stylesheet" href="../css/themes.css">
    <script src="../js/theme.js"></script>
</head>
<body>
    <div class="member-layout">
        <!-- Header -->
        <header class="member-header">
            <div class="member-header-inner">
                <a href="dashboard.html" class="member-logo">
                    <div class="member-logo-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <span class="member-logo-text" id="society-name">Society Maintenance</span>
                </a>

                <nav class="member-nav">
                    <a href="dashboard.html" class="member-nav-link">Dashboard</a>
                    <a href="bills.html" class="member-nav-link active">My Bills</a>
                    <a href="payments.html" class="member-nav-link">Payments</a>
                </nav>

                <button class="mobile-nav-toggle" onclick="toggleMobileNav()">‚ò∞</button>

                <div class="member-user">
                    <div class="member-user-info">
                        <div class="member-user-name" id="user-name">Member</div>
                        <div class="member-user-flat" id="user-flat">Flat -</div>
                    </div>
                    <div class="member-user-avatar" id="user-avatar">M</div>
                    <button class="member-logout-btn" onclick="handleLogout()" title="Logout">üö™</button>
                </div>
            </div>
        </header>

        <!-- Mobile Navigation -->
        <nav class="member-mobile-nav">
            <a href="dashboard.html" class="member-nav-link">Dashboard</a>
            <a href="bills.html" class="member-nav-link active">My Bills</a>
            <a href="payments.html" class="member-nav-link">Payments</a>
        </nav>

        <!-- Content -->
        <div class="member-content">
            <!-- Bill List View -->
            <div id="bills-list-view">
                <div class="page-header">
                    <h2>My Bills</h2>
                </div>

                <!-- Filter -->
                <div class="filter-bar mb-4">
                    <div class="form-group">
                        <select class="form-select" id="filter-year" onchange="filterBills()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="filter-status" onchange="filterBills()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="partial">Partial</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                </div>

                <div class="bill-card">
                    <ul class="bill-list" id="bills-list">
                        <li class="empty-state" style="padding: 2rem;">
                            <p class="text-muted text-center">Loading...</p>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bill Detail View -->
            <div id="bill-detail-view" class="d-none">
                <div class="page-header">
                    <div>
                        <button class="btn btn-outline-secondary btn-sm mb-2" onclick="showBillsList()">‚Üê Back to Bills</button>
                        <h2>Bill Details</h2>
                    </div>
                    <div class="page-header-actions no-print">
                        <button class="btn btn-primary" onclick="printBill()">Print Bill</button>
                    </div>
                </div>

                <div class="bill-detail-container">
                    <div class="bill-document" id="printable-bill">
                        <!-- Bill content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner spinner-lg"></div>
        <div class="loading-message">Loading...</div>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="bottom-nav-item">
            <span class="bottom-nav-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </span>
            <span class="bottom-nav-label">Home</span>
        </a>
        <a href="bills.html" class="bottom-nav-item active">
            <span class="bottom-nav-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
            </span>
            <span class="bottom-nav-label">Bills</span>
        </a>
        <a href="payments.html" class="bottom-nav-item">
            <span class="bottom-nav-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
            </span>
            <span class="bottom-nav-label">Payments</span>
        </a>
    </nav>

    <script src="../js/config.js?v=2"></script>
    <script src="../js/utils.js?v=2"></script>
    <script src="../js/storage.js?v=3"></script>
    <script src="../js/auth.js?v=2"></script>
    <script src="../js/member/main.js?v=2"></script>
    <script src="../js/mobile.js?v=2"></script>
    <script>
        let filteredBills = [];

        document.addEventListener('DOMContentLoaded', async function() {
            await initMemberPortal();
            setupYearFilter();
            filterBills();

            // Check for bill ID in URL
            const params = Utils.getUrlParams();
            if (params.id) {
                showBillDetail(params.id);
            }
        });

        function setupYearFilter() {
            const years = [...new Set(memberBills.map(b => b.year))].sort((a, b) => b - a);
            const select = document.getElementById('filter-year');
            select.innerHTML = '<option value="">All Years</option>' +
                years.map(y => `<option value="${y}">${y}</option>`).join('');
        }

        function filterBills() {
            const yearFilter = document.getElementById('filter-year').value;
            const statusFilter = document.getElementById('filter-status').value;

            filteredBills = memberBills.filter(bill => {
                const matchesYear = !yearFilter || bill.year === parseInt(yearFilter);
                const matchesStatus = !statusFilter || bill.status === statusFilter;
                return matchesYear && matchesStatus;
            });

            filteredBills.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.month - a.month;
            });

            renderBillsList();
        }

        function renderBillsList() {
            const container = document.getElementById('bills-list');

            if (filteredBills.length === 0) {
                container.innerHTML = `
                    <li class="empty-state" style="padding: 2rem;">
                        <p class="text-muted text-center">${memberBills.length === 0 ? 'No bills found' : 'No bills match your filter'}</p>
                    </li>
                `;
                return;
            }

            container.innerHTML = filteredBills.map(bill => {
                const balance = bill.grandTotal - (bill.paidAmount || 0);
                const isOverdue = bill.status !== 'paid' && Utils.isOverdue(bill.dueDate);

                return `
                    <li class="bill-list-item" onclick="showBillDetail('${bill.id}')" style="cursor: pointer;">
                        <div class="bill-info">
                            <div class="bill-month">
                                <span class="bill-month-name">${Utils.getMonthName(bill.month, true)}</span>
                                <span class="bill-month-year">${bill.year}</span>
                            </div>
                            <div class="bill-details">
                                <span class="bill-number">${bill.billNo}</span>
                                <span class="bill-date">
                                    Due: ${Utils.formatDate(bill.dueDate)}
                                    ${isOverdue ? '<span class="badge badge-danger ml-1">Overdue</span>' : ''}
                                </span>
                            </div>
                        </div>
                        <div class="bill-amount-status">
                            <span class="bill-amount">${Utils.formatCurrency(bill.grandTotal)}</span>
                            <span class="bill-status ${bill.status}">
                                ${bill.status === 'paid' ? 'Paid' : 'Due: ' + Utils.formatCurrency(balance)}
                            </span>
                        </div>
                        <div class="bill-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showBillDetail('${bill.id}')">View</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function showBillDetail(billId) {
            const bill = memberBills.find(b => b.id === billId);
            if (!bill) return;

            document.getElementById('bills-list-view').classList.add('d-none');
            document.getElementById('bill-detail-view').classList.remove('d-none');

            renderBillDetail(bill);
        }

        function showBillsList() {
            document.getElementById('bill-detail-view').classList.add('d-none');
            document.getElementById('bills-list-view').classList.remove('d-none');

            // Update URL
            window.history.pushState({}, '', 'bills.html');
        }

        function renderBillDetail(bill) {
            const building = masterData.buildings?.find(b => b.id === memberFlat?.buildingId);
            const balance = bill.grandTotal - (bill.paidAmount || 0);
            const chargeTypes = (masterData.chargeTypes || []).filter(c => c.isActive !== false);

            // Build numbered line items (Gulmohar style)
            let lineItemsHtml = '';
            let srNo = 0;

            // Map charge types to their amounts from bill line items
            chargeTypes.forEach(chargeType => {
                srNo++;
                const lineItem = bill.lineItems.find(item => item.chargeTypeId === chargeType.id);
                const amount = lineItem ? lineItem.amount : 0;

                lineItemsHtml += `
                    <tr>
                        <td class="text-center">${srNo}.</td>
                        <td>${Utils.escapeHtml(chargeType.name)}</td>
                        <td class="text-right amount">${amount > 0 ? Utils.formatCurrency(amount) : '-'}</td>
                    </tr>
                `;
            });

            // Add any line items that don't match known charge types
            bill.lineItems.forEach(item => {
                const hasChargeType = chargeTypes.some(c => c.id === item.chargeTypeId);
                if (!hasChargeType) {
                    srNo++;
                    lineItemsHtml += `
                        <tr>
                            <td class="text-center">${srNo}.</td>
                            <td>${Utils.escapeHtml(item.description)}</td>
                            <td class="text-right amount">${Utils.formatCurrency(item.amount)}</td>
                        </tr>
                    `;
                }
            });

            document.getElementById('printable-bill').innerHTML = `
                <div class="gulmohar-bill">
                    <!-- Society Header -->
                    <div style="border: 2px solid #1e40af; padding: 15px; text-align: center; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
                        <div style="font-size: 1.25rem; font-weight: bold; color: #1e40af;">${Utils.escapeHtml(settings.societyName || 'Society Name')}</div>
                        ${settings.registrationNo ? `<div style="font-size: 0.75rem; color: #64748b;">Reg. No.: ${Utils.escapeHtml(settings.registrationNo)}</div>` : ''}
                        <div style="font-size: 0.8rem; color: #475569;">${Utils.escapeHtml(settings.address || '')}</div>
                    </div>

                    <!-- Bill Info Row -->
                    <div style="display: flex; justify-content: space-between; border: 1px solid #e2e8f0; border-top: none; padding: 10px; background: #f8fafc;">
                        <div>
                            <span style="font-size: 0.75rem; color: #64748b;">Bill No.</span>
                            <strong style="display: block;">${bill.billNo}</strong>
                        </div>
                        <div style="text-align: center;">
                            <span style="font-size: 0.75rem; color: #64748b;">Date</span>
                            <strong style="display: block;">${Utils.formatDate(bill.generatedAt)}</strong>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 0.75rem; color: #64748b;">Due Date</span>
                            <strong style="display: block;">${Utils.formatDate(bill.dueDate)}</strong>
                        </div>
                    </div>

                    <!-- Member Info -->
                    <div style="border: 1px solid #e2e8f0; border-top: none; padding: 10px;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div>
                                <span style="font-size: 0.75rem; color: #64748b;">Flat No.</span>
                                <strong style="display: block;">${memberFlat ? Utils.escapeHtml(memberFlat.flatNo) : '-'}</strong>
                            </div>
                            <div>
                                <span style="font-size: 0.75rem; color: #64748b;">Building</span>
                                <strong style="display: block;">${building ? Utils.escapeHtml(building.name) : '-'}</strong>
                            </div>
                            <div style="flex: 1;">
                                <span style="font-size: 0.75rem; color: #64748b;">Shri/Smt.</span>
                                <strong style="display: block;">${memberFlat ? Utils.escapeHtml(memberFlat.ownerName) : '-'}</strong>
                            </div>
                            <div>
                                <span style="font-size: 0.75rem; color: #64748b;">For the Month</span>
                                <strong style="display: block;">${Utils.getMonthName(bill.month)} ${bill.year}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Bill Items Table -->
                    <table class="table" style="margin-top: 15px; border: 1px solid #e2e8f0;">
                        <thead>
                            <tr style="background: #1e40af; color: white;">
                                <th style="width: 50px; text-align: center;">Sr. No.</th>
                                <th>PARTICULARS</th>
                                <th style="width: 120px; text-align: right;">Amount (Rs.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lineItemsHtml}
                            <!-- Sub-Total -->
                            <tr style="background: #f1f5f9; font-weight: bold;">
                                <td></td>
                                <td>Sub-Total</td>
                                <td class="text-right amount">${Utils.formatCurrency(bill.totalAmount)}</td>
                            </tr>
                            <!-- Arrears Section -->
                            ${bill.previousDue > 0 ? `
                                <tr>
                                    <td></td>
                                    <td>Add: Arrears, if any</td>
                                    <td class="text-right amount" style="color: #dc2626;">${Utils.formatCurrency(bill.previousDue)}</td>
                                </tr>
                            ` : ''}
                            ${bill.interest > 0 ? `
                                <tr>
                                    <td></td>
                                    <td style="padding-left: 30px;">Interest on Arrears</td>
                                    <td class="text-right amount">${Utils.formatCurrency(bill.interest)}</td>
                                </tr>
                            ` : ''}
                            ${bill.penalty > 0 ? `
                                <tr>
                                    <td></td>
                                    <td style="padding-left: 30px;">Penalty</td>
                                    <td class="text-right amount">${Utils.formatCurrency(bill.penalty)}</td>
                                </tr>
                            ` : ''}
                            <!-- Grand Total -->
                            <tr style="background: #1e40af; color: white; font-weight: bold;">
                                <td></td>
                                <td>Grand Total</td>
                                <td class="text-right amount" style="font-size: 1.1rem;">${Utils.formatCurrency(bill.grandTotal)}</td>
                            </tr>
                            ${bill.paidAmount > 0 ? `
                                <tr style="background: #dcfce7;">
                                    <td></td>
                                    <td>Amount Paid</td>
                                    <td class="text-right amount" style="color: #16a34a;">${Utils.formatCurrency(bill.paidAmount)}</td>
                                </tr>
                                <tr style="background: #fee2e2; font-weight: bold;">
                                    <td></td>
                                    <td>Balance Due</td>
                                    <td class="text-right amount" style="color: #dc2626;">${Utils.formatCurrency(balance)}</td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>

                    <!-- Footer Notes -->
                    <div style="margin-top: 15px; padding: 10px; border: 1px solid #e2e8f0; background: #fffbeb; font-size: 0.75rem;">
                        <p style="margin: 0 0 5px 0;"><strong>Note:</strong></p>
                        <ol style="margin: 0; padding-left: 20px; color: #475569;">
                            <li>Interest of 2% per annum is applicable for late payments.</li>
                            <li>Payments after due date should be intimated immediately.</li>
                            <li>Any objection about this bill should be entertained within one month.</li>
                            <li>Please issue Crossed Cheque in favour of the Society.</li>
                        </ol>
                    </div>

                    <!-- Signature Section -->
                    <div style="display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px;">
                        <div style="text-align: center;">
                            <div style="border-top: 1px solid #000; width: 150px; padding-top: 5px; font-size: 0.75rem;">
                                Member Signature
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-top: 1px solid #000; width: 200px; padding-top: 5px; font-size: 0.75rem;">
                                For ${Utils.escapeHtml(settings.societyName || 'Society')}<br>
                                <span style="font-size: 0.7rem; color: #64748b;">Chairman/Secretary/Treasurer</span>
                            </div>
                        </div>
                    </div>

                    ${settings.phone ? `
                        <div style="text-align: center; margin-top: 15px; font-size: 0.75rem; color: #64748b;">
                            For queries contact: ${Utils.escapeHtml(settings.phone)}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function printBill() {
            window.print();
        }
    </script>
</body>
</html>
