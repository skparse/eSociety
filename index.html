<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Society Bills">
    <title>Society Maintenance Billing</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <link rel="stylesheet" href="css/style.css">
    <style>
        .login-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .login-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.875rem;
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .login-tab:hover {
            color: var(--primary);
        }

        .login-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            margin-bottom: -2px;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .not-configured-message {
            text-align: center;
            padding: 2rem;
        }

        .not-configured-message h2 {
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .not-configured-message p {
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .not-configured-message code {
            background: var(--gray-100);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="login-view" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div style="width: 60px; height: 60px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
                <h1>Society Maintenance</h1>
                <p>Billing Management System</p>
            </div>

            <!-- Not Configured Message (hidden by default) -->
            <div id="not-configured" class="not-configured-message" style="display: none;">
                <h2>Setup Required</h2>
                <p>This system hasn't been set up yet.</p>
                <p>Please contact your administrator to complete the setup.</p>
                <br>
                <p><small>Administrator? <a href="docs/setup-guide.html">View Setup Guide</a></small></p>
            </div>

            <!-- Login Form Container -->
            <div id="login-container">
                <!-- Login Tabs -->
                <div class="login-tabs">
                    <button class="login-tab active" data-tab="society">Society Login</button>
                    <button class="login-tab" data-tab="superadmin">Super Admin</button>
                </div>

                <!-- Society Login Tab -->
                <div id="society-tab" class="tab-content active">
                    <form id="society-login-form" class="login-form">
                        <!-- Hidden society code field (populated from URL parameter) -->
                        <input type="hidden" id="society-code" name="society-code" value="">

                        <div class="form-group">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" id="username" name="username" class="form-control" placeholder="Enter username" required autocomplete="username">
                        </div>

                        <div class="form-group">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" id="password" name="password" class="form-control" placeholder="Enter password" required autocomplete="current-password">
                        </div>

                        <div id="login-error" class="alert alert-danger d-none"></div>

                        <button type="submit" class="btn btn-primary btn-lg" id="login-btn">
                            <span id="login-btn-text">Sign In</span>
                            <span id="login-btn-spinner" class="spinner spinner-sm d-none"></span>
                        </button>
                    </form>

                    <div class="login-link">
                        <p>Default credentials: admin / admin123</p>
                    </div>
                </div>

                <!-- Superadmin Login Tab -->
                <div id="superadmin-tab" class="tab-content">
                    <form id="superadmin-login-form" class="login-form">
                        <div class="form-group">
                            <label for="super-username" class="form-label">Username</label>
                            <input type="text" id="super-username" name="super-username" class="form-control" placeholder="Enter superadmin username" required autocomplete="username">
                        </div>

                        <div class="form-group">
                            <label for="super-password" class="form-label">Password</label>
                            <input type="password" id="super-password" name="super-password" class="form-control" placeholder="Enter password" required autocomplete="current-password">
                        </div>

                        <div id="super-login-error" class="alert alert-danger d-none"></div>

                        <button type="submit" class="btn btn-primary btn-lg" id="super-login-btn">
                            <span id="super-login-btn-text">Sign In as Super Admin</span>
                            <span id="super-login-btn-spinner" class="spinner spinner-sm d-none"></span>
                        </button>
                    </form>

                    <div class="login-link">
                        <p>Superadmin access only</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner spinner-lg"></div>
        <div class="loading-message">Loading...</div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/mobile.js"></script>
    <script>
        let societyValidated = false;
        let validatedSocietyName = '';
        let societyFromUrl = false;

        // Encode society code for URL (obfuscation)
        function encodeSocietyCode(code) {
            // Reverse + Base64 encode
            const reversed = code.split('').reverse().join('');
            return btoa(reversed);
        }

        // Decode society code from URL
        function decodeSocietyCode(encoded) {
            try {
                const decoded = atob(encoded);
                return decoded.split('').reverse().join('');
            } catch (e) {
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check if Google Script is configured
            if (!isGoogleScriptConfigured()) {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('not-configured').style.display = 'block';
                return;
            }

            // Check if already logged in
            if (auth.isLoggedIn()) {
                redirectToDashboard();
                return;
            }

            // Setup tab switching
            setupTabs();

            // Check for encoded society code in URL parameter (?s=encoded)
            const urlParams = new URLSearchParams(window.location.search);
            const encodedParam = urlParams.get('s');

            if (encodedParam) {
                const societyCode = decodeSocietyCode(encodedParam);
                if (societyCode) {
                    const societyInput = document.getElementById('society-code');
                    societyInput.value = societyCode.toUpperCase();
                    societyFromUrl = true;

                    // Auto-validate society code
                    validateSocietyCode().then(() => {
                        if (societyValidated) {
                            // Focus on username field
                            document.getElementById('username').focus();
                        }
                    });
                }
            }

            // Handle form submissions
            document.getElementById('society-login-form').addEventListener('submit', handleSocietyLogin);
            document.getElementById('superadmin-login-form').addEventListener('submit', handleSuperadminLogin);
        });

        function setupTabs() {
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Show/hide tab content
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
        }

        async function validateSocietyCode() {
            const societyCode = document.getElementById('society-code').value.trim().toUpperCase();

            if (!societyCode || societyCode.length < 3) {
                societyValidated = false;
                return;
            }

            try {
                const result = await storage.validateSociety(societyCode);

                if (result.success && result.valid) {
                    societyValidated = true;
                    validatedSocietyName = result.societyName;
                } else {
                    societyValidated = false;
                }
            } catch (error) {
                societyValidated = false;
            }
        }

        async function handleSocietyLogin(e) {
            e.preventDefault();

            const societyCode = document.getElementById('society-code').value.trim().toUpperCase();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');
            const btnText = document.getElementById('login-btn-text');
            const btnSpinner = document.getElementById('login-btn-spinner');

            // Clear previous error
            errorDiv.classList.add('d-none');

            // Validate society code first if not already validated
            if (!societyValidated) {
                await validateSocietyCode();
                if (!societyValidated) {
                    errorDiv.textContent = 'Please enter a valid society code';
                    errorDiv.classList.remove('d-none');
                    return;
                }
            }

            // Show loading state
            loginBtn.disabled = true;
            btnText.textContent = 'Signing in...';
            btnSpinner.classList.remove('d-none');

            try {
                const result = await auth.login(societyCode, username, password, validatedSocietyName);

                if (result.success) {
                    Utils.showToast('Login successful!', 'success');
                    setTimeout(() => {
                        redirectToDashboard();
                    }, 500);
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.classList.remove('d-none');
                    resetButton(loginBtn, btnText, btnSpinner, 'Sign In');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'An error occurred. Please try again.';
                errorDiv.classList.remove('d-none');
                resetButton(loginBtn, btnText, btnSpinner, 'Sign In');
            }
        }

        async function handleSuperadminLogin(e) {
            e.preventDefault();

            const username = document.getElementById('super-username').value.trim();
            const password = document.getElementById('super-password').value;
            const errorDiv = document.getElementById('super-login-error');
            const loginBtn = document.getElementById('super-login-btn');
            const btnText = document.getElementById('super-login-btn-text');
            const btnSpinner = document.getElementById('super-login-btn-spinner');

            // Clear previous error
            errorDiv.classList.add('d-none');

            // Show loading state
            loginBtn.disabled = true;
            btnText.textContent = 'Signing in...';
            btnSpinner.classList.remove('d-none');

            try {
                const result = await auth.superadminLogin(username, password);

                if (result.success) {
                    Utils.showToast('Superadmin login successful!', 'success');
                    setTimeout(() => {
                        window.location.href = 'superadmin/dashboard.html';
                    }, 500);
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.classList.remove('d-none');
                    resetButton(loginBtn, btnText, btnSpinner, 'Sign In as Super Admin');
                }
            } catch (error) {
                console.error('Superadmin login error:', error);
                errorDiv.textContent = error.message || 'An error occurred. Please try again.';
                errorDiv.classList.remove('d-none');
                resetButton(loginBtn, btnText, btnSpinner, 'Sign In as Super Admin');
            }
        }

        function resetButton(btn, textEl, spinnerEl, text) {
            btn.disabled = false;
            textEl.textContent = text;
            spinnerEl.classList.add('d-none');
        }

        function redirectToDashboard() {
            // Check URL redirect parameter
            const params = Utils.getUrlParams();
            if (params.redirect) {
                window.location.href = params.redirect;
                return;
            }

            // Redirect based on role
            if (auth.isSuperadmin()) {
                window.location.href = 'superadmin/dashboard.html';
            } else if (auth.isAdmin()) {
                window.location.href = 'admin/dashboard.html';
            } else {
                window.location.href = 'member/dashboard.html';
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
